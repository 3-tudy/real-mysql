

# 외래키

MySQL에서 외래키는 InnoDB 스토리지 엔진에서만 생성할 수 있으며, 외래키 제약이 설정되면 자동으로 연관되는 테이블의
칼럼에 인덱스까지 생성된다. 외래키가 제거되지 않은 상태에서는 자동으로 생성된 인덱스를 삭제할 수 없다.

---

## 특징

InnoDB의 외래키 관리에는 중요한 두 가지 특징이 있다.

- 테이블의 변경(쓰기 잠금)이 발생하는 경우에만 잠금 경합(잠금 대기)이 발생한다.
- 외래키와 연관되지 않은 칼럼의 변경은 최대한 잠금 경함(잠금 대기)을 발생시키지 않는다.

### 자식 테이블의 변경이 대기하는 경우

자식 테이블의 외래 키 칼럼의 변경은 부모 테이블의 확인이 필요하다. 
따라서 자식 테이블에 외래키 칼럼의 변경을 위해서는 
부모 테이블의 해당 레코드에 쓰기 잠금이 해제될 때까지 대기해야 한다.

만약 자식 테이블의 외래키가 아닌 칼럼의 변경은 외래키로 인한 잠금 확장이 발생하지 않는다.

### 부모 테이블의 변경 작업이 대기하는 경우

반대로 자식 테이블의 레코드가 변경 중일 때 외래키로 연관되어 있는 부모 테이블의 레코드를 삭제하기 위해서는
자식 테이블 레코드의 쓰기 잠금이 해제될 때까지 기다려야 한다.

이는 자식 테이블이 생성될 때 정의된 외래키의 특성(ON DELETE CASCADE) 때문에 부모 레코드가 삭제되면
자식 레코드도 동시에 삭제되도록 동작하기 때문이다.

---

데이터 베이스에서 외래 키를 물리적으로 생성하려면 이러한 현상으로 인한 잠금 경합까지 고려해 모델링을 진행해야 한다.
중요한 고려 사항은 연관 테이블에 읽기 잠금이 걸린다는 것이고, 이렇게 잠금이 다른 테이블로 확장되면
그만큼 전체적으로 쿼리의 동시 처리에 영향을 미친다는 것이다.